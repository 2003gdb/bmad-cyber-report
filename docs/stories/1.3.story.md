# Story 1.3: Anonymous and Identified Reporting

## Status
Draft

## Story
**As a** mobile user,
**I want** to report cyber attacks either anonymously or with my account,
**so that** I can choose my privacy level while contributing to community protection.

## Acceptance Criteria
1. Anonymous users access reporting form immediately from app home screen
2. Registered users see toggle: "Reporte Identificado" vs "Reporte Anónimo"
3. Anonymous reports save without user_id association
4. Identified reports link to user account for history tracking
5. Both report types contribute equally to community trends and analytics
6. No functionality differences between anonymous and identified reports

## Tasks / Subtasks
- [ ] Create Report Submission API Endpoint (AC: 1, 3, 4, 6)
  - [ ] Implement POST /reportes endpoint with multipart/form-data support
  - [ ] Add anonymous-auth.guard.ts for anonymous + authenticated access
  - [ ] Handle is_anonymous boolean flag and user_id assignment logic
  - [ ] Implement file upload validation with Multer for attachments
  - [ ] Return Spanish success/error messages and recommendation data
- [ ] Implement Report Data Model and Repository (AC: 3, 4, 5)
  - [ ] Create reportes.repository.ts with MySQL direct queries
  - [ ] Implement crear-reporte.dto.ts with Spanish validation messages
  - [ ] Add database transaction wrapper for report + attachments
  - [ ] Handle anonymous vs identified report storage logic
  - [ ] Create adjuntos.repository.ts for file attachment management
- [ ] Create Report Service Layer (AC: 5, 6)
  - [ ] Implement reportes.service.ts with business logic
  - [ ] Add automatic recommendation generation based on attack_type
  - [ ] Ensure equal functionality for anonymous and identified reports
  - [ ] Integrate with community analytics for trend contributions
  - [ ] Add input validation and Spanish error handling
- [ ] Build iOS Report Submission Flow (AC: 1, 2)
  - [ ] Create ReportingViewModel with @Published properties for form state and error handling
  - [ ] Implement ReportSubmissionView.swift with SwiftUI declarative UI and MVVM binding
  - [ ] Add anonymous/identified toggle using AuthService.isAuthenticated state
  - [ ] Create ReportingService with async HTTP methods for API communication
  - [ ] Add file attachment picker with MIME type validation and image compression
  - [ ] Integrate secure file upload with temporary storage in app sandbox
- [ ] Add Report Module Integration (AC: 6)
  - [ ] Create reportes.module.ts with proper dependencies
  - [ ] Integrate with existing AuthModule and UsersModule
  - [ ] Register Spanish endpoints in main app.module.ts
  - [ ] Configure Multer for secure file upload handling
  - [ ] Add proper CORS configuration for mobile app
- [ ] Implement Unit and Integration Tests (Testing Requirements)
  - [ ] Test anonymous report creation without user_id
  - [ ] Test identified report creation with valid JWT tokens
  - [ ] Test file upload validation and secure storage
  - [ ] Test Spanish error message responses
  - [ ] Test report data validation with class-validator decorators
  - [ ] Mock database operations and file system interactions

## Dev Notes

### Previous Story Insights
Story 1.2 completed the authentication system with JWT tokens, bcrypt password security, and iOS authentication flow. The authentication infrastructure is fully implemented with triple authentication guards (anonymous, user, admin) and proper token management. ReportesModule structure is already referenced in the source tree but needs full implementation. The authentication choice UI is already built in iOS from Story 1.2.

### Data Models
- **Report Model**: Uses reportes table with id (INT AUTO_INCREMENT), user_id (INT, nullable), is_anonymous (BOOLEAN), attack_type (ENUM), incident_date (DATE), attack_origin (VARCHAR 255), impact_level (ENUM), status (ENUM default 'nuevo') [Source: architecture/database-schema.md#complete-schema]
- **ReportAttachment Model**: Uses reporte_adjuntos table with id, reporte_id (FK), file_path (VARCHAR 500), file_hash (VARCHAR 64), uploaded_at (TIMESTAMP) [Source: architecture/database-schema.md#complete-schema]
- **Anonymous Reporting Logic**: When is_anonymous=true, user_id must be NULL for privacy protection [Source: architecture/data-models.md#report-model]
- **Spanish ENUM Values**: attack_type includes 'email', 'SMS', 'whatsapp', 'llamada', 'redes_sociales', 'otro'; impact_level includes 'ninguno', 'robo_datos', 'robo_dinero', 'cuenta_comprometida' [Source: architecture/database-schema.md#complete-schema]

### API Specifications
- **Report Submission**: POST /reportes with multipart/form-data, anonymous access allowed, returns report object + recommendations + victim_support [Source: architecture/rest-api-spec.md#incident-reporting-endpoints]
- **Authentication Options**: Both BearerAuth and anonymous access supported on same endpoint [Source: architecture/rest-api-spec.md#incident-reporting-endpoints]
- **File Upload Support**: attachments array with binary files, file size validation required [Source: architecture/rest-api-spec.md#incident-reporting-endpoints]
- **Spanish Responses**: All error messages and API responses must be in Spanish [Source: architecture/coding-standards.md#critical-rules]
- **Required Fields**: attack_type, incident_date, attack_origin, impact_level are required; is_anonymous defaults to true [Source: architecture/rest-api-spec.md#incident-reporting-endpoints]

### Component Specifications
- **ReportesModule**: Spanish endpoints for incident reporting with POST /reportes, GET /reportes/:id, repository pattern implementation [Source: architecture/source-tree.md#current-implementation-structure]
- **Anonymous Auth Guard**: anonymous-auth.guard.ts allows both anonymous and authenticated access to same endpoints [Source: architecture/source-tree.md#current-implementation-structure]
- **Repository Pattern**: Controller → Service → Repository with reportes.controller.ts, reportes.service.ts, reportes.repository.ts separation [Source: architecture/source-tree.md#current-implementation-structure]
- **File Upload Module**: Multer 1.4.5 for secure file handling with validation support and local storage [Source: architecture/tech-stack.md#technology-stack-table]
- **Triple Authentication**: Anonymous access, JWT user tokens, JWT admin tokens with different permission levels [Source: architecture/high-level-architecture.md#architectural-and-design-patterns]
- **iOS MVVM Pattern**: SwiftUI views with ViewModel binding using @StateObject and @ObservedObject for reactive data binding [Source: frontend-architecture/ios-mobile-application-architecture.md#swiftui-mvvm-architecture-pattern]
- **iOS State Management**: Combine framework with @Published properties for automatic UI updates, Keychain for JWT token storage [Source: frontend-architecture/ios-mobile-application-architecture.md#ios-state-management-strategy]
- **iOS API Integration**: URLSession-based APIService with automatic JWT token refresh and Spanish error localization [Source: frontend-architecture/ios-mobile-application-architecture.md#ios-api-integration-patterns]

### File Locations
- **Backend Report Module**: packages/backend/src/reportes/ with reportes.controller.ts, reportes.service.ts, reportes.repository.ts, reportes.module.ts [Source: architecture/source-tree.md#current-implementation-structure]
- **DTOs Directory**: packages/backend/src/reportes/dto/crear-reporte.dto.ts for Spanish validation messages [Source: architecture/source-tree.md#current-implementation-structure]
- **Attachments Repository**: packages/backend/src/reportes/adjuntos.repository.ts for file attachment database operations [Source: architecture/source-tree.md#current-implementation-structure]
- **File Upload Storage**: packages/backend/uploads/ and packages/backend/uploads/temp/ for file processing [Source: architecture/source-tree.md#current-implementation-structure]
- **iOS Reporting Views**: packages/mobile/SafeTrade/Views/ with ReportSubmissionView.swift and related reporting UI components [Source: frontend-architecture/ios-mobile-application-architecture.md#core-components]
- **iOS ViewModels**: packages/mobile/SafeTrade/ViewModels/ with ReportingViewModel conforming to ObservableObject [Source: frontend-architecture/ios-mobile-application-architecture.md#mvvm-implementation-details]
- **iOS Services**: packages/mobile/SafeTrade/Services/ with ReportingService, APIService for HTTP communication [Source: frontend-architecture/ios-mobile-application-architecture.md#service-layer-business-logic-abstraction]
- **iOS Data Models**: packages/mobile/SafeTrade/Models/ with Report, AttackType, ImpactLevel Codable structs [Source: frontend-architecture/ios-mobile-application-architecture.md#ios-data-models]
- **Anonymous Auth Guard**: packages/backend/src/common/guards/anonymous-auth.guard.ts already exists [Source: architecture/source-tree.md#current-implementation-structure]

### Testing Requirements
- **Backend Testing**: Jest 29.5.0 + Supertest 6.3.0, *.spec.ts files alongside source files in reportes/ directory [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Integration Testing**: API endpoint testing with real database connections, test file upload handling with temporary directory cleanup [Source: architecture/test-strategy-and-standards.md#integration-tests]
- **File Upload Testing**: Test secure file handling with MIME type validation and size limits using test fixtures [Source: architecture/test-strategy-and-standards.md#test-data-management]
- **Anonymous Privacy Testing**: Verify no user_id, email, or personal data logged for anonymous reports (use 'anonymous' placeholder) [Source: architecture/coding-standards.md#critical-rules]
- **Security Testing**: Cover file upload security, SQL injection prevention with parameterized queries, JWT validation [Source: architecture/test-strategy-and-standards.md#unit-tests]

### Technical Constraints
- **No `any` Types**: TypeScript strict mode enabled, use proper typed interfaces for report DTOs and file upload responses [Source: architecture/coding-standards.md#core-standards]
- **Spanish Error Messages**: All user-facing error messages MUST be in Spanish, never return English error text [Source: architecture/coding-standards.md#critical-rules]
- **Anonymous Report Privacy**: NEVER log user_id, email, or personal data for reports where is_anonymous=true [Source: architecture/coding-standards.md#critical-rules]
- **File Upload Security**: NEVER accept file uploads without MIME type validation and size limits, use Multer configuration [Source: architecture/coding-standards.md#critical-rules]
- **Database Transactions**: ALL multi-table operations MUST use database transactions for report + attachments [Source: architecture/coding-standards.md#critical-rules]
- **Input Validation**: Use class-validator decorators on all DTOs with Spanish error messages [Source: architecture/coding-standards.md#critical-rules]
- **Direct MySQL Queries**: Use mysql2/promise with parameterized queries only, no ORM [Source: architecture/tech-stack.md#implementation-architecture]
- **Environment Variables**: MAX_FILE_SIZE, UPLOAD_PATH configured in .env for file upload limits [Source: architecture/tech-stack.md#environment-configuration-strategy]

### Testing
- **Test File Locations**: *.spec.ts files alongside source files in reportes/ directory [Source: architecture/coding-standards.md#core-standards]
- **Testing Framework**: Jest 29.5.0 with @nestjs/testing utilities for dependency injection testing [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **AAA Pattern**: Follow Arrange, Act, Assert pattern with descriptive test names in English [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **File Upload Testing**: Test file validation, secure storage, and cleanup with test fixtures in test/fixtures/ [Source: architecture/test-strategy-and-standards.md#test-data-management]
- **Mock Dependencies**: Mock all external dependencies (database, file system, recommendation service) [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Spanish Content Testing**: Use factory pattern for generating test entities with realistic Spanish content [Source: architecture/test-strategy-and-standards.md#test-data-management]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-15 | 1.0 | Initial story creation with complete architecture context | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*