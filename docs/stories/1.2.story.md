# Story 1.2: User Authentication System

## Status
Draft

## Story
**As a** mobile user,
**I want** the option to register and login with persistent sessions,
**so that** I can track my reports over time while still having the choice to report anonymously.

## Acceptance Criteria
1. App opens with choice: "Reportar Anónimamente" or "Iniciar Sesión/Registrarse"
2. Anonymous users can report immediately without any registration
3. Registration creates account with email/password and generates JWT token
4. JWT tokens maintain session across app opens/closes
5. Logged-in users can choose "Reporte Identificado" or "Reporte Anónimo" for each submission
6. Token refresh system prevents forced re-login during active usage

## Tasks / Subtasks
- [ ] Implement backend authentication endpoints (AC: 3, 4, 6)
  - [ ] Create register endpoint with salt generation and password hashing
  - [ ] Create login endpoint with JWT token generation and refresh tokens
  - [ ] Implement JWT validation middleware and guards
  - [ ] Add token refresh endpoint for session persistence
- [ ] Create iOS authentication views (AC: 1)
  - [ ] Implement app launch choice screen (Anonymous vs Login/Register)
  - [ ] Create registration form view with email/password validation
  - [ ] Create login form view with credential validation
  - [ ] Add Spanish error message handling for all auth forms
- [ ] Implement persistent session management (AC: 4, 5, 6)
  - [ ] Add secure token storage in iOS Keychain
  - [ ] Implement automatic token refresh logic
  - [ ] Create session state management across app lifecycle
  - [ ] Add logout functionality with token cleanup
- [ ] Integrate authentication with reporting flow (AC: 2, 5)
  - [ ] Maintain anonymous reporting without registration requirement
  - [ ] Add toggle for identified vs anonymous reports for logged-in users
  - [ ] Update reporting service to handle both auth states
  - [ ] Ensure both report types contribute to community analytics
- [ ] Create comprehensive authentication tests (Testing Requirements)
  - [ ] Unit tests for auth service methods and JWT token handling
  - [ ] Integration tests for registration/login endpoints with database
  - [ ] iOS unit tests for view models and authentication flows
  - [ ] Test salt generation uniqueness and password security

## Dev Notes

### Previous Story Insights
Story 1.1 established the complete project foundation including:
- NestJS backend with modular AuthModule structure ready for implementation
- iOS SwiftUI project with MVVM pattern and auth view structure outlined
- Database configuration with User model including salt field for enhanced security
- Shared types for cross-package consistency in authentication flows

### Data Models
- **User Model**: UUID primary key, email/password with bcrypt hashing, unique salt per user for enhanced security, JWT token storage field, timestamps [Source: architecture/data-models.md#user-model]
- **Salt Storage**: Each user has unique cryptographic salt stored in salt field for password hashing security [Source: architecture/data-models.md#user-model]
- **Report Model**: user_id field nullable to support both anonymous and identified reports, is_anonymous boolean flag [Source: architecture/data-models.md#report-model]

### API Specifications
- **Registration Endpoint**: POST `/auth/register` with email/password, returns JWT token and user data [Source: architecture/rest-api-spec.md#/auth/register]
- **Login Endpoint**: POST `/auth/login` with email/password, returns access_token, refresh_token, and user [Source: architecture/rest-api-spec.md#/auth/login]
- **JWT Token Management**: Bearer token authentication with refresh token system for persistent sessions [Source: architecture/rest-api-spec.md#components/securitySchemes]
- **Spanish Error Messages**: All authentication errors must be in Spanish per API specification [Source: architecture/coding-standards.md#critical-rules]

### Component Specifications
- **AuthModule Backend**: JWT strategy with Passport.js integration, bcrypt password hashing with individual salt generation, NestJS Guards for token validation [Source: architecture/components.md#authmodule]
- **iOS Auth Views**: LoginView.swift, RegisterView.swift, AnonymousChoiceView.swift in packages/mobile/SafeTrade/Views/Auth/ [Source: architecture/source-tree.md]
- **iOS ViewModels**: AuthViewModel.swift implementing MVVM pattern with @StateObject/@ObservedObject patterns [Source: architecture/source-tree.md]
- **JWT Guards**: jwt-auth.guard.ts, anonymous.guard.ts for protecting endpoints while allowing anonymous access [Source: architecture/source-tree.md]

### File Locations
- **Backend Auth Module**: packages/backend/src/auth/ with controller, service, guards/, strategies/, dto/ [Source: architecture/source-tree.md]
- **JWT Configuration**: packages/backend/src/shared/config/jwt.config.ts [Source: architecture/source-tree.md]
- **Crypto Utilities**: packages/backend/src/shared/utils/crypto.utils.ts for salt generation [Source: architecture/source-tree.md]
- **iOS Auth Implementation**: packages/mobile/SafeTrade/Views/Auth/, Services/AuthService.swift, ViewModels/AuthViewModel.swift [Source: architecture/source-tree.md]
- **Shared Types**: shared/types/auth.types.ts for cross-package authentication type consistency [Source: architecture/source-tree.md]

### Security Requirements
- **Password Security**: bcrypt hashing with salt rounds >= 12 combined with unique per-user salts generated via crypto.randomBytes() [Source: architecture/coding-standards.md#critical-rules]
- **JWT Validation**: ALL protected endpoints MUST validate JWT tokens using NestJS Guards, never custom validation [Source: architecture/coding-standards.md#critical-rules]
- **Spanish Error Messages**: All user-facing error messages MUST be in Spanish - never return English error text [Source: architecture/coding-standards.md#critical-rules]
- **Token Storage**: iOS must use Keychain for secure token persistence, never UserDefaults for sensitive data [Source: architecture/coding-standards.md#swift-specifics]

### iOS Implementation Requirements
- **SwiftUI Patterns**: Use @StateObject for AuthViewModel ownership, @ObservedObject for passed dependencies [Source: architecture/coding-standards.md#swift-specifics]
- **Async/Await**: Use structured concurrency for authentication API calls, avoid completion handlers [Source: architecture/coding-standards.md#swift-specifics]
- **Error Handling**: Use Result<Success, Failure> patterns with Spanish error messages [Source: architecture/coding-standards.md#swift-specifics]
- **Memory Management**: Use weak references for delegates to prevent retain cycles [Source: architecture/coding-standards.md#swift-specifics]

### Backend Implementation Requirements
- **TypeScript Standards**: Strict mode enabled, no `any` types, use absolute imports with path mapping [Source: architecture/coding-standards.md#typescript-specifics]
- **Authentication Flow**: Implement user registration workflow with salt generation per core workflow diagram [Source: architecture/core-workflows.md#user-registration-workflow]
- **Database Transactions**: Use Sequelize ORM with parameterized queries, never raw SQL [Source: architecture/coding-standards.md#critical-rules]
- **Environment Configuration**: Use JWT_SECRET and JWT_REFRESH_SECRET from environment variables [Source: architecture/tech-stack.md#environment-configuration-strategy]

### Testing
- **Test File Locations**: `*.spec.ts` files alongside source files for unit tests, `*.e2e-spec.ts` in test/ directory for integration tests, `*Tests.swift` in iOS test targets [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Testing Frameworks**: Jest 29.5.0 + @nestjs/testing for backend, XCTest for iOS native testing [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Security Testing**: Test salt generation uniqueness, password hashing security, JWT token validation, edge cases with invalid tokens [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Coverage Requirements**: 90% coverage for authentication and security modules due to critical nature [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- **AAA Pattern**: Follow Arrange, Act, Assert pattern with descriptive test names in English [Source: architecture/test-strategy-and-standards.md#unit-tests]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-14 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be populated by development agent -->

### Debug Log References
<!-- To be populated by development agent -->

### Completion Notes List
<!-- To be populated by development agent -->

### File List
<!-- To be populated by development agent -->

## QA Results
<!-- To be populated by QA agent -->