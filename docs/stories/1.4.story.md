# Story 1.4: Enhanced Reporting Data Collection

## Status
Draft

## Story
**As a** mobile user,
**I want** to provide detailed information about cyber attacks including URLs, message content, and screenshots,
**so that** my report contains comprehensive evidence for analysis and community protection.

## Acceptance Criteria
1. URL input field with validation for suspicious website reporting
2. Text area for copying and pasting original attack messages with character limit
3. Screenshot upload functionality with file size validation and secure storage
4. Impact assessment selection (ninguno, robo de datos, robo de dinero, cuenta comprometida)
5. File attachment support for additional evidence with secure handling
6. Form progress saving to prevent data loss during multi-step completion
7. All collected data properly structured and stored in database

## Tasks / Subtasks
- [ ] Enhance Report Data Model and Database Schema (AC: 1, 2, 7)
  - [ ] Add suspicious_url TEXT field to reportes table for malicious URL storage
  - [ ] Add message_content TEXT field to reportes table for attack message content
  - [ ] Add incident_time TIME field to reportes table for precise timing
  - [ ] Verify reporte_adjuntos table supports multiple file attachments per report
  - [ ] Create database migrations for new fields
- [ ] Update Report Submission API Endpoint (AC: 1, 2, 3, 5, 7)
  - [ ] Extend POST /reportes to accept suspicious_url with URL validation
  - [ ] Add message_content field with character limit validation (max 5000 characters)
  - [ ] Enhance multipart/form-data support for multiple file attachments
  - [ ] Add incident_time field for precise attack timing
  - [ ] Implement comprehensive input validation with Spanish error messages
- [ ] Enhance File Upload System (AC: 3, 5)
  - [ ] Extend Multer configuration to support multiple file types (images, PDFs, documents)
  - [ ] Implement file size validation per attachment (10MB max per file)
  - [ ] Add MIME type validation for security (images, PDFs only)
  - [ ] Enhance adjuntos.repository.ts for multiple file handling
  - [ ] Add file hash generation for integrity verification
- [ ] Create Enhanced iOS Report Form UI (AC: 1, 2, 3, 4, 6)
  - [ ] Add URLField component with validation for suspicious URLs
  - [ ] Create expandable text area for message content with character counter
  - [ ] Implement multi-image picker with camera and photo library support
  - [ ] Add impact assessment picker with Spanish labels and severity indicators
  - [ ] Create file attachment manager with preview and delete functionality
  - [ ] Implement form progress saving using UserDefaults for draft persistence
- [ ] Update iOS Data Models and Services (AC: 7)
  - [ ] Extend Report.swift model with suspiciousUrl, messageContent, incidentTime fields
  - [ ] Update ReportingService with enhanced multipart form data submission
  - [ ] Add file attachment models (AttachmentData) with metadata
  - [ ] Implement draft report persistence in ReportingViewModel
  - [ ] Add URL validation and character counting utilities
- [ ] Enhance Report Validation and Business Logic (AC: 1, 2, 7)
  - [ ] Create URL validation for suspicious links (format and security checks)
  - [ ] Implement character limit enforcement for message content (5000 chars)
  - [ ] Add comprehensive input sanitization for security
  - [ ] Enhance report completeness validation
  - [ ] Update recommendation engine to consider new data fields
- [ ] Update Unit and Integration Tests (Testing Requirements)
  - [ ] Test URL validation with malicious and valid URLs
  - [ ] Test message content character limit enforcement
  - [ ] Test multiple file upload validation and security
  - [ ] Test form progress saving and restoration
  - [ ] Test enhanced data model validation
  - [ ] Test Spanish error message responses for new fields

## Dev Notes

### Previous Story Insights
Story 1.3 completed the core anonymous and identified reporting system with file upload capability. The basic report submission infrastructure is fully implemented with POST /reportes endpoint, multipart/form-data support, anonymous authentication, and file attachment handling. The iOS reporting flow is established with ReportingViewModel, ReportSubmissionView, and ReportingService. Form validation, Spanish error messages, and basic file upload are working. The existing infrastructure provides the foundation for enhanced data collection.

### Data Models
- **Enhanced Report Model**: Extends existing reportes table with suspicious_url (TEXT), message_content (TEXT), incident_time (TIME nullable) fields [Source: architecture/database-schema.md#complete-schema]
- **Character Limits**: message_content field supports up to 5000 characters for attack message preservation [Source: architecture/data-models.md#report-model]
- **URL Storage**: suspicious_url field stores malicious URLs as TEXT with validation for format and security [Source: architecture/data-models.md#report-model]
- **Time Precision**: incident_time adds precise timing to complement incident_date for detailed timeline analysis [Source: architecture/data-models.md#report-model]
- **File Attachments**: Existing reporte_adjuntos table supports multiple file attachments per report with file_path, file_hash integrity [Source: architecture/database-schema.md#complete-schema]

### API Specifications
- **Enhanced Report Submission**: POST /reportes extends existing multipart/form-data to accept suspicious_url, message_content, incident_time fields [Source: architecture/rest-api-spec.md#incident-reporting-endpoints]
- **URL Validation**: suspicious_url field accepts valid HTTP/HTTPS URLs with security validation for malicious content [Source: architecture/rest-api-spec.md#incident-reporting-endpoints]
- **Character Limits**: message_content accepts up to 5000 characters with validation error for Spanish user feedback [Source: architecture/rest-api-spec.md#incident-reporting-endpoints]
- **Multiple File Support**: attachments array supports multiple binary files with individual validation per attachment [Source: architecture/rest-api-spec.md#incident-reporting-endpoints]
- **Time Format**: incident_time accepts HH:MM:SS format for precise attack timing [Source: architecture/rest-api-spec.md#incident-reporting-endpoints]

### Component Specifications
- **Extended ReportesModule**: packages/backend/src/reportes/ enhances existing controller, service, repository for new fields [Source: architecture/source-tree.md#current-implementation-structure]
- **Enhanced DTOs**: packages/backend/src/reportes/dto/crear-reporte.dto.ts adds validation decorators for URL and text fields [Source: architecture/source-tree.md#current-implementation-structure]
- **Multer Enhancement**: Existing Multer 1.4.5 configuration extends to support multiple file types with MIME validation [Source: architecture/tech-stack.md#technology-stack-table]
- **iOS Enhanced Form**: packages/mobile/SafeTrade/Views/Reporting/ extends ReportSubmissionView with URL field, text area, file picker [Source: frontend-architecture/ios-mobile-application-architecture.md#core-components]
- **iOS Enhanced ViewModel**: packages/mobile/SafeTrade/ViewModels/ReportingViewModel extends with form progress saving and validation [Source: frontend-architecture/ios-mobile-application-architecture.md#mvvm-implementation-details]

### File Locations
- **Backend Report Enhancement**: packages/backend/src/reportes/reportes.controller.ts, reportes.service.ts, reportes.repository.ts [Source: architecture/source-tree.md#current-implementation-structure]
- **Database Migration**: packages/backend/database/ for adding new fields to reportes table schema [Source: architecture/source-tree.md#current-implementation-structure]
- **Enhanced DTOs**: packages/backend/src/reportes/dto/crear-reporte.dto.ts for new field validation [Source: architecture/source-tree.md#current-implementation-structure]
- **File Upload Enhancement**: packages/backend/uploads/ and packages/backend/uploads/temp/ for multiple file handling [Source: architecture/source-tree.md#current-implementation-structure]
- **iOS Enhanced Views**: packages/mobile/SafeTrade/Views/Reporting/ReportSubmissionView.swift for enhanced form UI [Source: frontend-architecture/ios-mobile-application-architecture.md#core-components]
- **iOS Enhanced ViewModels**: packages/mobile/SafeTrade/ViewModels/ReportingViewModel.swift for form progress and validation [Source: frontend-architecture/ios-mobile-application-architecture.md#mvvm-implementation-details]
- **iOS Enhanced Services**: packages/mobile/SafeTrade/Services/ReportingService.swift for enhanced API communication [Source: frontend-architecture/ios-mobile-application-architecture.md#service-layer-business-logic-abstraction]
- **iOS Enhanced Models**: packages/mobile/SafeTrade/Models/Report.swift for new fields and AttachmentData model [Source: frontend-architecture/ios-mobile-application-architecture.md#ios-data-models]

### Testing Requirements
- **Backend Testing**: Jest 29.5.0 + Supertest 6.3.0, extend existing *.spec.ts files in reportes/ directory [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **URL Validation Testing**: Test malicious URL detection, format validation, and security checks with test fixtures [Source: architecture/test-strategy-and-standards.md#test-data-management]
- **File Upload Testing**: Test multiple file upload handling, MIME type validation, size limits with test fixtures [Source: architecture/test-strategy-and-standards.md#test-data-management]
- **Form Progress Testing**: Test draft report saving and restoration functionality with state persistence [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Character Limit Testing**: Test message content validation with 5000 character limit enforcement [Source: architecture/test-strategy-and-standards.md#unit-tests]

### Technical Constraints
- **No `any` Types**: TypeScript strict mode for all new URL validation and form handling code [Source: architecture/coding-standards.md#core-standards]
- **Spanish Error Messages**: All validation errors for new fields MUST be in Spanish [Source: architecture/coding-standards.md#critical-rules]
- **File Upload Security**: NEVER accept files without MIME type validation, 10MB max per file [Source: architecture/coding-standards.md#critical-rules]
- **URL Security**: NEVER store URLs without validation, implement security checks for malicious content [Source: architecture/coding-standards.md#critical-rules]
- **Database Transactions**: ALL enhanced multi-field operations MUST use database transactions [Source: architecture/coding-standards.md#critical-rules]
- **Input Validation**: Use class-validator decorators for URL format, character limits with Spanish messages [Source: architecture/coding-standards.md#critical-rules]
- **Character Limits**: message_content field enforced at 5000 characters with validation feedback [Source: architecture/coding-standards.md#critical-rules]

### Testing
- **Test File Enhancement**: Extend existing *.spec.ts files in reportes/ directory for new functionality [Source: architecture/coding-standards.md#core-standards]
- **Testing Framework**: Jest 29.5.0 with @nestjs/testing for enhanced field validation testing [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **AAA Pattern**: Follow Arrange, Act, Assert for URL validation, file upload, and form progress tests [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Security Testing**: Test URL validation against malicious links, file upload security, character limit enforcement [Source: architecture/test-strategy-and-standards.md#test-data-management]
- **Spanish Content Testing**: Use factory pattern for generating test data with realistic Spanish content [Source: architecture/test-strategy-and-standards.md#test-data-management]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-17 | 1.0 | Initial story creation with enhanced data collection requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be filled by development agent)

### Debug Log References
(To be filled by development agent)

### Completion Notes List
(To be filled by development agent)

### File List
(To be filled by development agent)

## QA Results
(To be filled by QA agent)